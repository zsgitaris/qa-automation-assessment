name: Mobile Automation CI

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  android-test:
    runs-on: macos-latest # Use macos-latest for built-in Android emulator support

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Download App
        run: |
          mkdir -p resources/android
          # Direct link to the latest APK from the releases page
          curl -L https://github.com/saucelabs/sample-app-mobile/releases/download/2.7.1/Android.SauceLabs.Mobile.Sample.app.2.7.1.apk -o resources/android/sample.apk

      - name: Set up Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: default
          arch: x86_64
          profile: Nexus 6
          disk-size: 2000M
          script: echo "Emulator started"

      - name: Start Appium Server
        run: |
          # Install Appium globally for easy access
          npm install -g appium
          # Start Appium server in the background
          appium --use-drivers uiautomator2 &
          APPIUM_PID=$!
          echo "APPIUM_PID=$APPIUM_PID" >> $GITHUB_ENV
          sleep 10 # Wait for Appium to start

      - name: Run Mobile Tests
        run: |
          # Set environment variables required by the driver.ts
          export APK_PATH=resources/android/sample.apk
          export APPIUM_HOST=127.0.0.1
          export APPIUM_PORT=4723
          npm run test:mobile

      - name: Generate Allure Report
        if: always()
        run: npm run allure:generate:mobile

      - name: Upload Allure Report Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report-mobile
          path: allure-report/mobile

      - name: Stop Appium Server
        if: always()
        run: kill ${{ env.APPIUM_PID }}
